#{to_json =>
   {with_defs,
    {#{<<"ByteRange">> =>
        {struct,#{start => {required,integer},'end' => {required,integer}}},
       <<"CodexErrorInfo">> =>
        {any_of,
         [{enum,
           [contextWindowExceeded,usageLimitExceeded,internalServerError,
            unauthorized,badRequest,threadRollbackFailed,sandboxError,other]},
          {struct,
           #{modelCap =>
              {required,
               {struct,
                #{model => {required,binstr},
                  reset_after_seconds =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}},
          {struct,
           #{httpConnectionFailed =>
              {required,
               {struct,
                #{httpStatusCode =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}},
          {struct,
           #{responseStreamConnectionFailed =>
              {required,
               {struct,
                #{httpStatusCode =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}},
          {struct,
           #{responseStreamDisconnected =>
              {required,
               {struct,
                #{httpStatusCode =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}},
          {struct,
           #{responseTooManyFailedAttempts =>
              {required,
               {struct,
                #{httpStatusCode =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}}]},
       <<"CollabAgentState">> =>
        {struct,
         #{message => {optional,{any_of,[binstr,{exact,null}]}},
           status => {required,{ref,<<"CollabAgentStatus">>}}}},
       <<"CollabAgentStatus">> =>
        {enum,[pendingInit,running,completed,errored,shutdown,notFound]},
       <<"CollabAgentTool">> => {enum,[spawnAgent,sendInput,wait,closeAgent]},
       <<"CollabAgentToolCallStatus">> => {enum,[inProgress,completed,failed]},
       <<"CommandAction">> =>
        {any_of,
         [{struct,
           #{command => {required,binstr},
             name => {required,binstr},
             type => {required,{enum,[read]}},
             path => {required,binstr}}},
          {struct,
           #{command => {required,binstr},
             type => {required,{enum,[listFiles]}},
             path => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{command => {required,binstr},
             type => {required,{enum,[search]}},
             path => {optional,{any_of,[binstr,{exact,null}]}},
             query => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{command => {required,binstr},
             type => {required,{enum,[unknown]}}}}]},
       <<"CommandExecutionStatus">> =>
        {enum,[inProgress,completed,failed,declined]},
       <<"FileUpdateChange">> =>
        {struct,
         #{path => {required,binstr},
           diff => {required,binstr},
           kind => {required,{ref,<<"PatchChangeKind">>}}}},
       <<"GitInfo">> =>
        {struct,
         #{branch => {optional,{any_of,[binstr,{exact,null}]}},
           sha => {optional,{any_of,[binstr,{exact,null}]}},
           originUrl => {optional,{any_of,[binstr,{exact,null}]}}}},
       <<"McpToolCallError">> => {struct,#{message => {required,binstr}}},
       <<"McpToolCallResult">> =>
        {struct,
         #{content => {required,{list,term}},
           structuredContent => {optional,term}}},
       <<"McpToolCallStatus">> => {enum,[inProgress,completed,failed]},
       <<"PatchApplyStatus">> => {enum,[inProgress,completed,failed,declined]},
       <<"PatchChangeKind">> =>
        {any_of,
         [{struct,#{type => {required,{enum,[add]}}}},
          {struct,#{type => {required,{enum,[delete]}}}},
          {struct,
           #{type => {required,{enum,[update]}},
             move_path => {optional,{any_of,[binstr,{exact,null}]}}}}]},
       <<"SessionSource">> =>
        {any_of,
         [{enum,[cli,vscode,exec,appServer,unknown]},
          {struct,#{subAgent => {required,{ref,<<"SubAgentSource">>}}}}]},
       <<"SubAgentSource">> =>
        {any_of,
         [{enum,[review,compact]},
          {struct,
           #{thread_spawn =>
              {required,
               {struct,
                #{depth => {required,integer},
                  parent_thread_id => {required,{ref,<<"ThreadId">>}}}}}}},
          {struct,#{other => {required,binstr}}}]},
       <<"TextElement">> =>
        {struct,
         #{byteRange => {required,{all_of,[{ref,<<"ByteRange">>}]}},
           placeholder => {optional,{any_of,[binstr,{exact,null}]}}}},
       <<"Thread">> =>
        {struct,
         #{id => {required,binstr},
           path => {optional,{any_of,[binstr,{exact,null}]}},
           source => {required,{all_of,[{ref,<<"SessionSource">>}]}},
           cwd => {required,binstr},
           modelProvider => {required,binstr},
           cliVersion => {required,binstr},
           gitInfo => {optional,{any_of,[{ref,<<"GitInfo">>},{exact,null}]}},
           preview => {required,binstr},
           updatedAt => {required,integer},
           createdAt => {required,integer},
           turns => {required,{list,{ref,<<"Turn">>}}}}},
       <<"ThreadId">> => binstr,
       <<"ThreadItem">> =>
        {any_of,
         [{struct,
           #{id => {required,binstr},
             type => {required,{enum,[userMessage]}},
             content => {required,{list,{ref,<<"UserInput">>}}}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[agentMessage]}},
             text => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[plan]}},
             text => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[reasoning]}},
             content => {optional,{default,{[],{list,binstr}}}},
             summary => {optional,{default,{[],{list,binstr}}}}}},
          {struct,
           #{command => {required,binstr},
             id => {required,binstr},
             status => {required,{ref,<<"CommandExecutionStatus">>}},
             type => {required,{enum,[commandExecution]}},
             cwd => {required,binstr},
             commandActions => {required,{list,{ref,<<"CommandAction">>}}},
             processId => {optional,{any_of,[binstr,{exact,null}]}},
             exitCode => {optional,{any_of,[integer,{exact,null}]}},
             aggregatedOutput => {optional,{any_of,[binstr,{exact,null}]}},
             durationMs => {optional,{any_of,[integer,{exact,null}]}}}},
          {struct,
           #{id => {required,binstr},
             status => {required,{ref,<<"PatchApplyStatus">>}},
             type => {required,{enum,[fileChange]}},
             changes => {required,{list,{ref,<<"FileUpdateChange">>}}}}},
          {struct,
           #{error =>
              {optional,{any_of,[{ref,<<"McpToolCallError">>},{exact,null}]}},
             id => {required,binstr},
             status => {required,{ref,<<"McpToolCallStatus">>}},
             type => {required,{enum,[mcpToolCall]}},
             arguments => {required,term},
             result =>
              {optional,{any_of,[{ref,<<"McpToolCallResult">>},{exact,null}]}},
             server => {required,binstr},
             tool => {required,binstr},
             durationMs => {optional,{any_of,[integer,{exact,null}]}}}},
          {struct,
           #{id => {required,binstr},
             status =>
              {required,{all_of,[{ref,<<"CollabAgentToolCallStatus">>}]}},
             type => {required,{enum,[collabAgentToolCall]}},
             prompt => {optional,{any_of,[binstr,{exact,null}]}},
             tool => {required,{all_of,[{ref,<<"CollabAgentTool">>}]}},
             agentsStates =>
              {required,{map,{binstr,{ref,<<"CollabAgentState">>}}}},
             receiverThreadIds => {required,{list,binstr}},
             senderThreadId => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[webSearch]}},
             query => {required,binstr},
             action =>
              {optional,{any_of,[{ref,<<"WebSearchAction">>},{exact,null}]}}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[imageView]}},
             path => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[enteredReviewMode]}},
             review => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[exitedReviewMode]}},
             review => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[contextCompaction]}}}}]},
       <<"Turn">> =>
        {struct,
         #{error => {optional,{any_of,[{ref,<<"TurnError">>},{exact,null}]}},
           id => {required,binstr},
           status => {required,{ref,<<"TurnStatus">>}},
           items => {required,{list,{ref,<<"ThreadItem">>}}}}},
       <<"TurnError">> =>
        {struct,
         #{message => {required,binstr},
           additionalDetails =>
            {optional,{default,{null,{any_of,[binstr,{exact,null}]}}}},
           codexErrorInfo =>
            {optional,{any_of,[{ref,<<"CodexErrorInfo">>},{exact,null}]}}}},
       <<"TurnStatus">> => {enum,[completed,interrupted,failed,inProgress]},
       <<"UserInput">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[text]}},
             text => {required,binstr},
             text_elements =>
              {optional,{default,{[],{list,{ref,<<"TextElement">>}}}}}}},
          {struct,
           #{type => {required,{enum,[image]}},url => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[localImage]}},
             path => {required,binstr}}},
          {struct,
           #{name => {required,binstr},
             type => {required,{enum,[skill]}},
             path => {required,binstr}}},
          {struct,
           #{name => {required,binstr},
             type => {required,{enum,[mention]}},
             path => {required,binstr}}}]},
       <<"WebSearchAction">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[search]}},
             query => {optional,{any_of,[binstr,{exact,null}]}},
             queries => {optional,{any_of,[{list,binstr},{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[openPage]}},
             url => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[findInPage]}},
             pattern => {optional,{any_of,[binstr,{exact,null}]}},
             url => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,#{type => {required,{enum,[other]}}}}]}},
     {struct,#{thread => {required,{all_of,[{ref,<<"Thread">>}]}}}}}},
  from_json =>
   {with_defs,
    {#{<<"ByteRange">> =>
        {struct,#{start => {required,integer},'end' => {required,integer}}},
       <<"CodexErrorInfo">> =>
        {any_of,
         [{enum,
           [contextWindowExceeded,usageLimitExceeded,internalServerError,
            unauthorized,badRequest,threadRollbackFailed,sandboxError,other]},
          {struct,
           #{modelCap =>
              {required,
               {struct,
                #{model => {required,binstr},
                  reset_after_seconds =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}},
          {struct,
           #{httpConnectionFailed =>
              {required,
               {struct,
                #{httpStatusCode =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}},
          {struct,
           #{responseStreamConnectionFailed =>
              {required,
               {struct,
                #{httpStatusCode =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}},
          {struct,
           #{responseStreamDisconnected =>
              {required,
               {struct,
                #{httpStatusCode =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}},
          {struct,
           #{responseTooManyFailedAttempts =>
              {required,
               {struct,
                #{httpStatusCode =>
                   {optional,{any_of,[integer,{exact,null}]}}}}}}}]},
       <<"CollabAgentState">> =>
        {struct,
         #{message => {optional,{any_of,[binstr,{exact,null}]}},
           status => {required,{ref,<<"CollabAgentStatus">>}}}},
       <<"CollabAgentStatus">> =>
        {enum,[pendingInit,running,completed,errored,shutdown,notFound]},
       <<"CollabAgentTool">> => {enum,[spawnAgent,sendInput,wait,closeAgent]},
       <<"CollabAgentToolCallStatus">> => {enum,[inProgress,completed,failed]},
       <<"CommandAction">> =>
        {any_of,
         [{struct,
           #{command => {required,binstr},
             name => {required,binstr},
             type => {required,{enum,[read]}},
             path => {required,binstr}}},
          {struct,
           #{command => {required,binstr},
             type => {required,{enum,[listFiles]}},
             path => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{command => {required,binstr},
             type => {required,{enum,[search]}},
             path => {optional,{any_of,[binstr,{exact,null}]}},
             query => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{command => {required,binstr},
             type => {required,{enum,[unknown]}}}}]},
       <<"CommandExecutionStatus">> =>
        {enum,[inProgress,completed,failed,declined]},
       <<"FileUpdateChange">> =>
        {struct,
         #{path => {required,binstr},
           diff => {required,binstr},
           kind => {required,{ref,<<"PatchChangeKind">>}}}},
       <<"GitInfo">> =>
        {struct,
         #{branch => {optional,{any_of,[binstr,{exact,null}]}},
           sha => {optional,{any_of,[binstr,{exact,null}]}},
           originUrl => {optional,{any_of,[binstr,{exact,null}]}}}},
       <<"McpToolCallError">> => {struct,#{message => {required,binstr}}},
       <<"McpToolCallResult">> =>
        {struct,
         #{content => {required,{list,term}},
           structuredContent => {optional,term}}},
       <<"McpToolCallStatus">> => {enum,[inProgress,completed,failed]},
       <<"PatchApplyStatus">> => {enum,[inProgress,completed,failed,declined]},
       <<"PatchChangeKind">> =>
        {any_of,
         [{struct,#{type => {required,{enum,[add]}}}},
          {struct,#{type => {required,{enum,[delete]}}}},
          {struct,
           #{type => {required,{enum,[update]}},
             move_path => {optional,{any_of,[binstr,{exact,null}]}}}}]},
       <<"SessionSource">> =>
        {any_of,
         [{enum,[cli,vscode,exec,appServer,unknown]},
          {struct,#{subAgent => {required,{ref,<<"SubAgentSource">>}}}}]},
       <<"SubAgentSource">> =>
        {any_of,
         [{enum,[review,compact]},
          {struct,
           #{thread_spawn =>
              {required,
               {struct,
                #{depth => {required,integer},
                  parent_thread_id => {required,{ref,<<"ThreadId">>}}}}}}},
          {struct,#{other => {required,binstr}}}]},
       <<"TextElement">> =>
        {struct,
         #{byteRange => {required,{all_of,[{ref,<<"ByteRange">>}]}},
           placeholder => {optional,{any_of,[binstr,{exact,null}]}}}},
       <<"Thread">> =>
        {struct,
         #{id => {required,binstr},
           path => {optional,{any_of,[binstr,{exact,null}]}},
           source => {required,{all_of,[{ref,<<"SessionSource">>}]}},
           cwd => {required,binstr},
           modelProvider => {required,binstr},
           cliVersion => {required,binstr},
           gitInfo => {optional,{any_of,[{ref,<<"GitInfo">>},{exact,null}]}},
           preview => {required,binstr},
           updatedAt => {required,integer},
           createdAt => {required,integer},
           turns => {required,{list,{ref,<<"Turn">>}}}}},
       <<"ThreadId">> => binstr,
       <<"ThreadItem">> =>
        {any_of,
         [{struct,
           #{id => {required,binstr},
             type => {required,{enum,[userMessage]}},
             content => {required,{list,{ref,<<"UserInput">>}}}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[agentMessage]}},
             text => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[plan]}},
             text => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[reasoning]}},
             content => {optional,{default,{[],{list,binstr}}}},
             summary => {optional,{default,{[],{list,binstr}}}}}},
          {struct,
           #{command => {required,binstr},
             id => {required,binstr},
             status => {required,{ref,<<"CommandExecutionStatus">>}},
             type => {required,{enum,[commandExecution]}},
             cwd => {required,binstr},
             commandActions => {required,{list,{ref,<<"CommandAction">>}}},
             processId => {optional,{any_of,[binstr,{exact,null}]}},
             exitCode => {optional,{any_of,[integer,{exact,null}]}},
             aggregatedOutput => {optional,{any_of,[binstr,{exact,null}]}},
             durationMs => {optional,{any_of,[integer,{exact,null}]}}}},
          {struct,
           #{id => {required,binstr},
             status => {required,{ref,<<"PatchApplyStatus">>}},
             type => {required,{enum,[fileChange]}},
             changes => {required,{list,{ref,<<"FileUpdateChange">>}}}}},
          {struct,
           #{error =>
              {optional,{any_of,[{ref,<<"McpToolCallError">>},{exact,null}]}},
             id => {required,binstr},
             status => {required,{ref,<<"McpToolCallStatus">>}},
             type => {required,{enum,[mcpToolCall]}},
             arguments => {required,term},
             result =>
              {optional,{any_of,[{ref,<<"McpToolCallResult">>},{exact,null}]}},
             server => {required,binstr},
             tool => {required,binstr},
             durationMs => {optional,{any_of,[integer,{exact,null}]}}}},
          {struct,
           #{id => {required,binstr},
             status =>
              {required,{all_of,[{ref,<<"CollabAgentToolCallStatus">>}]}},
             type => {required,{enum,[collabAgentToolCall]}},
             prompt => {optional,{any_of,[binstr,{exact,null}]}},
             tool => {required,{all_of,[{ref,<<"CollabAgentTool">>}]}},
             agentsStates =>
              {required,{map,{binstr,{ref,<<"CollabAgentState">>}}}},
             receiverThreadIds => {required,{list,binstr}},
             senderThreadId => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[webSearch]}},
             query => {required,binstr},
             action =>
              {optional,{any_of,[{ref,<<"WebSearchAction">>},{exact,null}]}}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[imageView]}},
             path => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[enteredReviewMode]}},
             review => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[exitedReviewMode]}},
             review => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[contextCompaction]}}}}]},
       <<"Turn">> =>
        {struct,
         #{error => {optional,{any_of,[{ref,<<"TurnError">>},{exact,null}]}},
           id => {required,binstr},
           status => {required,{ref,<<"TurnStatus">>}},
           items => {required,{list,{ref,<<"ThreadItem">>}}}}},
       <<"TurnError">> =>
        {struct,
         #{message => {required,binstr},
           additionalDetails =>
            {optional,{default,{null,{any_of,[binstr,{exact,null}]}}}},
           codexErrorInfo =>
            {optional,{any_of,[{ref,<<"CodexErrorInfo">>},{exact,null}]}}}},
       <<"TurnStatus">> => {enum,[completed,interrupted,failed,inProgress]},
       <<"UserInput">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[text]}},
             text => {required,binstr},
             text_elements =>
              {optional,{default,{[],{list,{ref,<<"TextElement">>}}}}}}},
          {struct,
           #{type => {required,{enum,[image]}},url => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[localImage]}},
             path => {required,binstr}}},
          {struct,
           #{name => {required,binstr},
             type => {required,{enum,[skill]}},
             path => {required,binstr}}},
          {struct,
           #{name => {required,binstr},
             type => {required,{enum,[mention]}},
             path => {required,binstr}}}]},
       <<"WebSearchAction">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[search]}},
             query => {optional,{any_of,[binstr,{exact,null}]}},
             queries => {optional,{any_of,[{list,binstr},{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[openPage]}},
             url => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[findInPage]}},
             pattern => {optional,{any_of,[binstr,{exact,null}]}},
             url => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,#{type => {required,{enum,[other]}}}}]}},
     {struct,#{thread => {required,{all_of,[{ref,<<"Thread">>}]}}}}}}}.
