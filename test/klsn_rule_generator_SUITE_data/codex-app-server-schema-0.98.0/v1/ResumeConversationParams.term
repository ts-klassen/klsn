#{to_json =>
   {with_defs,
    {#{<<"AskForApproval">> =>
        {any_of,
         [{enum,[<<"untrusted">>]},
          {enum,[<<"on-failure">>]},
          {enum,[<<"on-request">>]},
          {enum,[<<"never">>]}]},
       <<"ContentItem">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"input_text">>]}},
             text => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[<<"input_image">>]}},
             image_url => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[<<"output_text">>]}},
             text => {required,binstr}}}]},
       <<"FunctionCallOutputBody">> =>
        {any_of,[binstr,{list,{ref,<<"FunctionCallOutputContentItem">>}}]},
       <<"FunctionCallOutputContentItem">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"input_text">>]}},
             text => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[<<"input_image">>]}},
             image_url => {required,binstr}}}]},
       <<"FunctionCallOutputPayload">> =>
        {struct,
         #{success => {optional,{any_of,[boolean,{exact,null}]}},
           body => {required,{ref,<<"FunctionCallOutputBody">>}}}},
       <<"GhostCommit">> =>
        {struct,
         #{id => {required,binstr},
           parent => {optional,{any_of,[binstr,{exact,null}]}},
           preexisting_untracked_dirs => {required,{list,binstr}},
           preexisting_untracked_files => {required,{list,binstr}}}},
       <<"LocalShellAction">> =>
        {any_of,
         [{struct,
           #{command => {required,{list,binstr}},
             env => {optional,{any_of,[{map,{binstr,term}},{exact,null}]}},
             type => {required,{enum,[<<"exec">>]}},
             user => {optional,{any_of,[binstr,{exact,null}]}},
             timeout_ms => {optional,{any_of,[integer,{exact,null}]}},
             working_directory =>
              {optional,{any_of,[binstr,{exact,null}]}}}}]},
       <<"LocalShellStatus">> =>
        {enum,[<<"completed">>,<<"in_progress">>,<<"incomplete">>]},
       <<"MessagePhase">> => {enum,[<<"commentary">>,<<"final_answer">>]},
       <<"NewConversationParams">> =>
        {struct,
         #{profile => {optional,{any_of,[binstr,{exact,null}]}},
           config => {optional,{any_of,[{map,{binstr,term}},{exact,null}]}},
           cwd => {optional,{any_of,[binstr,{exact,null}]}},
           model => {optional,{any_of,[binstr,{exact,null}]}},
           approvalPolicy =>
            {optional,{any_of,[{ref,<<"AskForApproval">>},{exact,null}]}},
           baseInstructions => {optional,{any_of,[binstr,{exact,null}]}},
           compactPrompt => {optional,{any_of,[binstr,{exact,null}]}},
           developerInstructions => {optional,{any_of,[binstr,{exact,null}]}},
           includeApplyPatchTool => {optional,{any_of,[boolean,{exact,null}]}},
           modelProvider => {optional,{any_of,[binstr,{exact,null}]}},
           sandbox =>
            {optional,{any_of,[{ref,<<"SandboxMode">>},{exact,null}]}}}},
       <<"ReasoningItemContent">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"reasoning_text">>]}},
             text => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[<<"text">>]}},
             text => {required,binstr}}}]},
       <<"ReasoningItemReasoningSummary">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"summary_text">>]}},
             text => {required,binstr}}}]},
       <<"ResponseItem">> =>
        {any_of,
         [{struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             type => {required,{enum,[<<"message">>]}},
             content => {required,{list,{ref,<<"ContentItem">>}}},
             end_turn => {optional,{any_of,[boolean,{exact,null}]}},
             phase =>
              {optional,{any_of,[{ref,<<"MessagePhase">>},{exact,null}]}},
             role => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[<<"reasoning">>]}},
             content =>
              {optional,
               {default,
                {null,
                 {any_of,
                  [{list,{ref,<<"ReasoningItemContent">>}},{exact,null}]}}}},
             summary =>
              {required,{list,{ref,<<"ReasoningItemReasoningSummary">>}}},
             encrypted_content => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             status => {required,{ref,<<"LocalShellStatus">>}},
             type => {required,{enum,[<<"local_shell_call">>]}},
             action => {required,{ref,<<"LocalShellAction">>}},
             call_id => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             name => {required,binstr},
             type => {required,{enum,[<<"function_call">>]}},
             arguments => {required,binstr},
             call_id => {required,binstr}}},
          {struct,
           #{output => {required,{ref,<<"FunctionCallOutputPayload">>}},
             type => {required,{enum,[<<"function_call_output">>]}},
             call_id => {required,binstr}}},
          {struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             input => {required,binstr},
             name => {required,binstr},
             status => {optional,{any_of,[binstr,{exact,null}]}},
             type => {required,{enum,[<<"custom_tool_call">>]}},
             call_id => {required,binstr}}},
          {struct,
           #{output => {required,binstr},
             type => {required,{enum,[<<"custom_tool_call_output">>]}},
             call_id => {required,binstr}}},
          {struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             status => {optional,{any_of,[binstr,{exact,null}]}},
             type => {required,{enum,[<<"web_search_call">>]}},
             action =>
              {optional,{any_of,[{ref,<<"WebSearchAction">>},{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[<<"ghost_snapshot">>]}},
             ghost_commit => {required,{ref,<<"GhostCommit">>}}}},
          {struct,
           #{type => {required,{enum,[<<"compaction">>]}},
             encrypted_content => {required,binstr}}},
          {struct,#{type => {required,{enum,[<<"other">>]}}}}]},
       <<"SandboxMode">> =>
        {enum,
         [<<"read-only">>,<<"workspace-write">>,<<"danger-full-access">>]},
       <<"ThreadId">> => binstr,
       <<"WebSearchAction">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"search">>]}},
             query => {optional,{any_of,[binstr,{exact,null}]}},
             queries => {optional,{any_of,[{list,binstr},{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[<<"open_page">>]}},
             url => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[<<"find_in_page">>]}},
             pattern => {optional,{any_of,[binstr,{exact,null}]}},
             url => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,#{type => {required,{enum,[<<"other">>]}}}}]}},
     {struct,
      #{path => {optional,{any_of,[binstr,{exact,null}]}},
        history =>
         {optional,{any_of,[{list,{ref,<<"ResponseItem">>}},{exact,null}]}},
        conversationId =>
         {optional,{any_of,[{ref,<<"ThreadId">>},{exact,null}]}},
        overrides =>
         {optional,
          {any_of,[{ref,<<"NewConversationParams">>},{exact,null}]}}}}}},
  from_json =>
   {with_defs,
    {#{<<"AskForApproval">> =>
        {any_of,
         [{enum,[<<"untrusted">>]},
          {enum,[<<"on-failure">>]},
          {enum,[<<"on-request">>]},
          {enum,[<<"never">>]}]},
       <<"ContentItem">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"input_text">>]}},
             text => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[<<"input_image">>]}},
             image_url => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[<<"output_text">>]}},
             text => {required,binstr}}}]},
       <<"FunctionCallOutputBody">> =>
        {any_of,[binstr,{list,{ref,<<"FunctionCallOutputContentItem">>}}]},
       <<"FunctionCallOutputContentItem">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"input_text">>]}},
             text => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[<<"input_image">>]}},
             image_url => {required,binstr}}}]},
       <<"FunctionCallOutputPayload">> =>
        {struct,
         #{success => {optional,{any_of,[boolean,{exact,null}]}},
           body => {required,{ref,<<"FunctionCallOutputBody">>}}}},
       <<"GhostCommit">> =>
        {struct,
         #{id => {required,binstr},
           parent => {optional,{any_of,[binstr,{exact,null}]}},
           preexisting_untracked_dirs => {required,{list,binstr}},
           preexisting_untracked_files => {required,{list,binstr}}}},
       <<"LocalShellAction">> =>
        {any_of,
         [{struct,
           #{command => {required,{list,binstr}},
             env => {optional,{any_of,[{map,{binstr,term}},{exact,null}]}},
             type => {required,{enum,[<<"exec">>]}},
             user => {optional,{any_of,[binstr,{exact,null}]}},
             timeout_ms => {optional,{any_of,[integer,{exact,null}]}},
             working_directory =>
              {optional,{any_of,[binstr,{exact,null}]}}}}]},
       <<"LocalShellStatus">> =>
        {enum,[<<"completed">>,<<"in_progress">>,<<"incomplete">>]},
       <<"MessagePhase">> => {enum,[<<"commentary">>,<<"final_answer">>]},
       <<"NewConversationParams">> =>
        {struct,
         #{profile => {optional,{any_of,[binstr,{exact,null}]}},
           config => {optional,{any_of,[{map,{binstr,term}},{exact,null}]}},
           cwd => {optional,{any_of,[binstr,{exact,null}]}},
           model => {optional,{any_of,[binstr,{exact,null}]}},
           approvalPolicy =>
            {optional,{any_of,[{ref,<<"AskForApproval">>},{exact,null}]}},
           baseInstructions => {optional,{any_of,[binstr,{exact,null}]}},
           compactPrompt => {optional,{any_of,[binstr,{exact,null}]}},
           developerInstructions => {optional,{any_of,[binstr,{exact,null}]}},
           includeApplyPatchTool => {optional,{any_of,[boolean,{exact,null}]}},
           modelProvider => {optional,{any_of,[binstr,{exact,null}]}},
           sandbox =>
            {optional,{any_of,[{ref,<<"SandboxMode">>},{exact,null}]}}}},
       <<"ReasoningItemContent">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"reasoning_text">>]}},
             text => {required,binstr}}},
          {struct,
           #{type => {required,{enum,[<<"text">>]}},
             text => {required,binstr}}}]},
       <<"ReasoningItemReasoningSummary">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"summary_text">>]}},
             text => {required,binstr}}}]},
       <<"ResponseItem">> =>
        {any_of,
         [{struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             type => {required,{enum,[<<"message">>]}},
             content => {required,{list,{ref,<<"ContentItem">>}}},
             end_turn => {optional,{any_of,[boolean,{exact,null}]}},
             phase =>
              {optional,{any_of,[{ref,<<"MessagePhase">>},{exact,null}]}},
             role => {required,binstr}}},
          {struct,
           #{id => {required,binstr},
             type => {required,{enum,[<<"reasoning">>]}},
             content =>
              {optional,
               {default,
                {null,
                 {any_of,
                  [{list,{ref,<<"ReasoningItemContent">>}},{exact,null}]}}}},
             summary =>
              {required,{list,{ref,<<"ReasoningItemReasoningSummary">>}}},
             encrypted_content => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             status => {required,{ref,<<"LocalShellStatus">>}},
             type => {required,{enum,[<<"local_shell_call">>]}},
             action => {required,{ref,<<"LocalShellAction">>}},
             call_id => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             name => {required,binstr},
             type => {required,{enum,[<<"function_call">>]}},
             arguments => {required,binstr},
             call_id => {required,binstr}}},
          {struct,
           #{output => {required,{ref,<<"FunctionCallOutputPayload">>}},
             type => {required,{enum,[<<"function_call_output">>]}},
             call_id => {required,binstr}}},
          {struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             input => {required,binstr},
             name => {required,binstr},
             status => {optional,{any_of,[binstr,{exact,null}]}},
             type => {required,{enum,[<<"custom_tool_call">>]}},
             call_id => {required,binstr}}},
          {struct,
           #{output => {required,binstr},
             type => {required,{enum,[<<"custom_tool_call_output">>]}},
             call_id => {required,binstr}}},
          {struct,
           #{id => {optional,{any_of,[binstr,{exact,null}]}},
             status => {optional,{any_of,[binstr,{exact,null}]}},
             type => {required,{enum,[<<"web_search_call">>]}},
             action =>
              {optional,{any_of,[{ref,<<"WebSearchAction">>},{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[<<"ghost_snapshot">>]}},
             ghost_commit => {required,{ref,<<"GhostCommit">>}}}},
          {struct,
           #{type => {required,{enum,[<<"compaction">>]}},
             encrypted_content => {required,binstr}}},
          {struct,#{type => {required,{enum,[<<"other">>]}}}}]},
       <<"SandboxMode">> =>
        {enum,
         [<<"read-only">>,<<"workspace-write">>,<<"danger-full-access">>]},
       <<"ThreadId">> => binstr,
       <<"WebSearchAction">> =>
        {any_of,
         [{struct,
           #{type => {required,{enum,[<<"search">>]}},
             query => {optional,{any_of,[binstr,{exact,null}]}},
             queries => {optional,{any_of,[{list,binstr},{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[<<"open_page">>]}},
             url => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,
           #{type => {required,{enum,[<<"find_in_page">>]}},
             pattern => {optional,{any_of,[binstr,{exact,null}]}},
             url => {optional,{any_of,[binstr,{exact,null}]}}}},
          {struct,#{type => {required,{enum,[<<"other">>]}}}}]}},
     {struct,
      #{path => {optional,{any_of,[binstr,{exact,null}]}},
        history =>
         {optional,{any_of,[{list,{ref,<<"ResponseItem">>}},{exact,null}]}},
        conversationId =>
         {optional,{any_of,[{ref,<<"ThreadId">>},{exact,null}]}},
        overrides =>
         {optional,
          {any_of,[{ref,<<"NewConversationParams">>},{exact,null}]}}}}}}}.
